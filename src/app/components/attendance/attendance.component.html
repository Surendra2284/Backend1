<div class="container">
  <h1>Attendance Management</h1>

  <!-- Summary / Dashboard -->
  <div class="summary">
    <div class="card">Total <strong>{{ totals.total }}</strong></div>
    <div class="card">Present <strong>{{ totals.Present }}</strong> ({{ totals.pctPresent }}%)</div>
    <div class="card">Absent <strong>{{ totals.Absent }}</strong> ({{ totals.pctAbsent }}%)</div>
    <div class="card">Leave <strong>{{ totals.Leave }}</strong> ({{ totals.pctLeave }}%)</div>
  </div>

  <!-- Filters -->
  <form [formGroup]="filterForm" class="filters" (ngSubmit)="applyFilters()">
    <input type="text" placeholder="Class" formControlName="className" />
    <input type="text" placeholder="Student name" formControlName="name" />
    <input type="text" placeholder="Username" formControlName="username" />
    <input type="text" placeholder="Student ID" formControlName="studentId" />
    <input type="date" formControlName="date" />
    <select formControlName="status">
      <option value="">Any status</option>
      <option value="Present">Present</option>
      <option value="Absent">Absent</option>
      <option value="Leave">Leave</option>
    </select>
    <button type="submit">Search</button>
    <button type="button" (click)="clearFilters()">Clear</button>

    <div class="spacer"></div>
    <button type="button" (click)="exportExcel()">Export Excel</button>
    <button type="button" (click)="exportPDF()">Export PDF</button>
  </form>

  <!-- Create / Bulk Mark -->
  <h2>Mark Attendance</h2>
  <form [formGroup]="attendanceForm" class="create" novalidate>
    <input id="className" type="text" placeholder="Class" formControlName="className" />
    <input id="teacher" type="text" placeholder="Teacher" formControlName="teacher" />
    <input id="username" type="text" placeholder="Username" formControlName="username" />
    <input id="date" type="date" formControlName="date" />

    <select id="status" formControlName="status">
      <option value="Present">Present</option>
      <option value="Absent">Absent</option>
      <option value="Leave">Leave</option>
    </select>

    <div class="student-list">
      <div class="select-all">
        <input id="selectAll" type="checkbox" [checked]="allSelected" (change)="toggleSelectAll($event)" />
        <label for="selectAll">Select all</label>
      </div>

      <div class="students">
        <!-- Use trackBy function; prefer _id, fallback to studentId -->
        <label
          class="student"
          *ngFor="let s of students; trackBy: trackByStudent"
          [attr.for]="s._id || ('sid_' + s.studentId)"
        >
          <input
            type="checkbox"
            [id]="s._id || ('sid_' + s.studentId)"
            [(ngModel)]="s.selected"
            [ngModelOptions]="{ standalone: true }"
            [name]="'student_' + (s._id || ('sid_' + s.studentId))"
          />
          <span>{{ s.name }} ({{ s.class }})</span>
        </label>
      </div>
    </div>

    <button type="button" (click)="saveAttendance()" [disabled]="attendanceForm.invalid || loading">
      {{ loading ? 'Saving…' : 'Save Attendance' }}
    </button>
  </form>

  <div class="result">{{ message }}</div>

  <!-- Table (sorting + paging) -->
  <h2>Attendance Records</h2>

  <div class="table-controls">
    <label>
      Page size:
      <select
        [ngModel]="pageSize"
        [ngModelOptions]="{ standalone: true }"
        (ngModelChange)="onPageSizeChange($event)"
      >
        <option *ngFor="let s of [5,10,20,50]" [value]="s">{{ s }}</option>
      </select>
    </label>
  </div>

  <table>
    <thead>
      <tr>
        <th (click)="setSort('student')">Student</th>
        <th (click)="setSort('className')">Class</th>
        <th (click)="setSort('teacher')">Teacher</th>
        <th (click)="setSort('username')">Username</th>
        <th (click)="setSort('date')">Date</th>
        <th (click)="setSort('status')">Status</th>
        <th>Actions</th>
      </tr>
    </thead>

    <tbody>
      <!-- Server returns the current page; we sort locally -->
      <tr *ngFor="let r of sorted; trackBy: trackByRecord">
        <td>{{ getStudentName(r) }} ({{ getStudentId(r) }})</td>
        <td>{{ r.className }}</td>
        <td>{{ r.teacher }}</td>
        <td>{{ r.username }}</td>
        <td>{{ r.date ? (r.date | date:'yyyy-MM-dd') : '' }}</td>

        <td>
          <!-- Inline correction: dropdown pushes to /attendance/correct -->
          <select [ngModel]="r.status" (ngModelChange)="correctStatus(r, $event)">
            <option value="Present">Present</option>
            <option value="Absent">Absent</option>
            <option value="Leave">Leave</option>
          </select>
        </td>

        <td>
          <button (click)="correctStatus(r, 'Present')">Mark Present</button>
          <button (click)="deleteAttendance(r._id!)">Delete</button>
        </td>
      </tr>
    </tbody>
  </table>

  <div class="pager">
    <button (click)="prevPage()" [disabled]="page <= 1">&laquo; Prev</button>
    <span>Page {{ page }} / {{ totalPages }} &nbsp; • &nbsp; Total records: {{ totalCount }}</span>
    <button (click)="nextPage()" [disabled]="page >= totalPages">Next &raquo;</button>
  </div>
</div>
