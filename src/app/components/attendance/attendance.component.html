<div class="attendance-wrapper">

  <!-- ======================
       HEADER
  ====================== -->
  <div class="att-header fade-in">
    <h2 class="title">
      <span class="icon">ðŸ“Š</span>
      Attendance Management
    </h2>

    <p class="subtitle">
      Mark attendance, filter reports & export results easily.
    </p>

    <div *ngIf="message" class="toast">{{ message }}</div>
  </div>

  <!-- ======================
       MOBILE VIEW
  ====================== -->
  <ng-container *ngIf="isMobile">

    <!-- Card : Mark Attendance -->
    <div class="att-card slide-up">

      <h3 class="section-title">Mark Attendance</h3>

      <form [formGroup]="attendanceForm" (ngSubmit)="saveAttendance()">

        <input formControlName="className" class="input" placeholder="Class (e.g. 6A)"
               (blur)="onClassChange()" />

        <input formControlName="teacher" class="input" placeholder="Teacher Name" />

        <input formControlName="username" class="input" placeholder="Your Username" />

        <div class="row-2">
          <input type="date" formControlName="date" class="input" />
          <select formControlName="status" class="input">
            <option>Present</option>
            <option>Absent</option>
            <option>Leave</option>
          </select>
        </div>

        <!-- Students Box -->
        <div class="student-box">

          <div class="box-head">
            <strong>Students</strong>

            <label class="small">
              <input type="checkbox" (change)="toggleSelectAll($event)" [checked]="allSelected" />
              Select All
            </label>
          </div>

          <div class="student-list">
            <div *ngFor="let s of students">
              <div class="student-item">
                <div class="info">
                  <strong>{{ getStudentLabel(s) }}</strong>
                  <small>ID: {{ s.studentId }}</small>
                </div>
                <input type="checkbox" [(ngModel)]="s.selected"
                       [ngModelOptions]="{standalone:true}" />
              </div>
            </div>

            <p *ngIf="!students.length" class="empty">Enter class name to load students.</p>
          </div>

        </div>

        <button class="btn-primary full">Save Attendance</button>

      </form>
    </div>


    <!-- Filters -->
    <div class="att-card slide-up">

      <h3 class="section-title">Filters</h3>

      <form [formGroup]="filterForm" (ngSubmit)="applyFilters()">

        <input formControlName="className" class="input" placeholder="Class" />
        <input formControlName="studentName" class="input" placeholder="Student Name" />
        <input formControlName="studentId" class="input" placeholder="Student ID" />
        <input formControlName="username" class="input" placeholder="Marked By" />

        <div class="row-2">
          <input type="date" formControlName="fromDate" class="input" />
          <input type="date" formControlName="toDate" class="input" />
        </div>

        <select class="input" formControlName="status">
          <option value="">All</option>
          <option value="Present">Present</option>
          <option value="Absent">Absent</option>
          <option value="Leave">Leave</option>
        </select>

        <button class="btn-secondary full">Apply Filters</button>
      </form>
    </div>


    <!-- History -->
    <div class="att-card slide-up">

      <h3 class="section-title">Attendance History</h3>

      <div *ngFor="let a of sortedHistory" class="history-item">
        <strong>{{ getStudentName(a) }}</strong>
        <small>ID: {{ a.studentId }}</small>

        <div class="mini-grid">
          <span>Date:</span><span>{{ formatDate(a.date) }}</span>
          <span>Class:</span><span>{{ a.className }}</span>
          <span>Teacher:</span><span>{{ a.teacher }}</span>
          <span>By:</span><span>{{ a.username }}</span>
          <span>Status:</span>
          <span>
            <span class="status" [class.present]="a.status==='Present'"
                                [class.absent]="a.status==='Absent'"
                                [class.leave]="a.status==='Leave'">
              {{ a.status }}
            </span>
          </span>
        </div>

        <button class="btn-danger full small"
                (click)="deleteAttendance(a._id || '')">
          Delete
        </button>

        <hr>
      </div>

      <p *ngIf="!sortedHistory.length" class="empty">No records found</p>

    </div>


    <!-- Absent List -->
    <div class="att-card slide-up">
      <h3 class="section-title">Absent List</h3>

      <div *ngFor="let a of absentList" class="absent-item">
        <strong>{{ a.name }}</strong>
        <small>ID: {{ a.studentId }}</small>

        <div class="dates">
          <small *ngFor="let d of a.dates; let last = last">
            {{ d }}<span *ngIf="!last">, </span>
          </small>
        </div>

        <hr />
      </div>

      <p *ngIf="!absentList.length" class="empty">No absences.</p>
    </div>

  </ng-container>

  <!-- ======================
       DESKTOP VIEW
  ====================== -->
  <ng-container *ngIf="!isMobile">

    <div class="desktop-grid">

      <!-- Left panel -->
      <div class="left-panel slide-left">
        <div class="att-card">
          <h3 class="section-title">Add / Mark Attendance</h3>

          <form [formGroup]="attendanceForm" (ngSubmit)="saveAttendance()">

            <label>Class</label>
            <input formControlName="className" class="input"
                   placeholder="Class name (e.g. 8A)" (blur)="onClassChange()" />

            <label>Teacher</label>
            <input formControlName="teacher" class="input" placeholder="Teacher Name" />

            <label>Marked By</label>
            <input formControlName="username" class="input" placeholder="Username" />

            <div class="row-2">
              <div>
                <label>Date</label>
                <input type="date" formControlName="date" class="input" />
              </div>

              <div>
                <label>Status</label>
                <select formControlName="status" class="input">
                  <option>Present</option>
                  <option>Absent</option>
                  <option>Leave</option>
                </select>
              </div>
            </div>

            <!-- Students -->
            <div class="student-box desktop-student-box">
              <div class="box-head">
                <strong>Students</strong>

                <label class="small">
                  <input type="checkbox" (change)="toggleSelectAll($event)"
                         [checked]="allSelected" />
                  Select All
                </label>
              </div>

              <div class="student-list big">
                <div *ngIf="!students.length" class="empty small">
                  Enter class name to load students.
                </div>

                <div *ngFor="let s of students" class="student-row big-row">
                  <input type="checkbox" [(ngModel)]="s.selected"
                         [ngModelOptions]="{standalone:true}" />

                  <div>
                    <strong>{{ getStudentLabel(s) }}</strong><br>
                    <small>ID: {{ s.studentId }}</small>
                  </div>
                </div>
              </div>
            </div>

            <button class="btn-primary full mt-2">Save Attendance</button>

          </form>
        </div>
      </div>

      <!-- Right panel -->
      <div class="right-panel slide-right">

        <!-- Filters -->
        <div class="att-card">
          <h3 class="section-title">Filters</h3>

          <form [formGroup]="filterForm" (ngSubmit)="applyFilters()">

            <div class="row-3">
              <input formControlName="className" class="input" placeholder="Class" />
              <input formControlName="studentName" class="input" placeholder="Student" />
              <input formControlName="studentId" class="input" placeholder="ID" />
            </div>

            <div class="row-3 mt-2">
              <input formControlName="username" class="input" placeholder="Marked By" />
              <input formControlName="fromDate" type="date" class="input" />
              <input formControlName="toDate" type="date" class="input" />
            </div>

            <div class="row-2 mt-2">
              <select formControlName="status" class="input">
                <option value="">All Status</option>
                <option value="Present">Present</option>
                <option value="Absent">Absent</option>
                <option value="Leave">Leave</option>
              </select>

              <button class="btn-secondary full">Apply Filters</button>
            </div>
          </form>
        </div>


        <!-- History Table -->
        <div class="att-card fade-in">
          <h3 class="section-title">Attendance History</h3>

          <div class="table-wrapper">
            <table class="themed-table">
              <thead>
                <tr>
                  <th>Student</th>
                  <th>Date</th>
                  <th>Class</th>
                  <th>Teacher</th>
                  <th>By</th>
                  <th>Status</th>
                  <th class="text-end">Delete</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let a of sortedHistory">
                  <td>
                    <strong>{{ getStudentName(a) }}</strong><br>
                    <small>{{ a.studentId }}</small>
                  </td>
                  <td>{{ formatDate(a.date) }}</td>
                  <td>{{ a.className }}</td>
                  <td>{{ a.teacher }}</td>
                  <td>{{ a.username }}</td>
                  <td>
                    <span class="status"
                      [class.present]="a.status==='Present'"
                      [class.absent]="a.status==='Absent'"
                      [class.leave]="a.status==='Leave'">
                      {{ a.status }}
                    </span>
                  </td>
                  <td class="text-end">
                    <button class="btn-danger small"
                            (click)="deleteAttendance(a._id || '')">
                      Delete
                    </button>
                  </td>
                </tr>

                <tr *ngIf="!sortedHistory.length">
                  <td colspan="7" class="empty text-center">No records found.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>


        <!-- Monthly Matrix -->
        <div class="att-card">
          <h3 class="section-title">Monthly Matrix</h3>

          <div class="table-wrapper matrix">
            <table class="matrix-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>ID</th>
                  <th *ngFor="let d of matrixDates">{{ d | date:'dd' }}</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let row of matrixRows">
                  <td>{{ row.name }}</td>
                  <td>{{ row.studentId }}</td>

                  <td *ngFor="let d of matrixDates">
                    <span class="matrix-cell"
                      [class.present]="row.perDate[d]==='Present'"
                      [class.absent]="row.perDate[d]==='Absent'"
                      [class.leave]="row.perDate[d]==='Leave'">
                      {{
                        row.perDate[d]=='Present'? 'P' :
                        row.perDate[d]=='Absent'? 'A' :
                        row.perDate[d]=='Leave'? 'L' : ''
                      }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>


        <!-- Absent List -->
        <div class="att-card fade-in">
          <h3 class="section-title">Absent List</h3>

          <div *ngFor="let a of absentList" class="absent-row">
            <strong>{{ a.name }}</strong> â€” <small>{{ a.studentId }}</small>

            <div class="small text-muted">
              <span *ngFor="let d of a.dates; let last = last">
                {{ d }}<span *ngIf="!last">, </span>
              </span>
            </div>
          </div>

          <p *ngIf="!absentList.length" class="empty">No absences.</p>
        </div>


        <!-- Export Buttons -->
        <div class="export-bar">
          <button class="btn-primary small" (click)="exportExcel()">Export Excel</button>
          <button class="btn-secondary small" (click)="exportPDF()">Export PDF</button>
        </div>

      </div>

    </div>

  </ng-container>

</div>
