<div class="container py-4">
  <h2 class="text-center mb-4">🎓 Student Management System</h2>

  <!-- 🔍 Search Section -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">🔍 Search Students</h5>
      <div class="row g-2 align-items-center">
        <div class="col-md-5">
          <input
            type="text"
            class="form-control"
            [(ngModel)]="searchQuery"
            placeholder="Enter class or name"
            name="searchQuery"
          />
        </div>
        <div class="col-md-3">
          <select class="form-select" [(ngModel)]="searchBy" name="searchBy">
            <option value="class">By Class</option>
            <option value="name">By Name</option>
          </select>
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100" (click)="searchStudents()">Search</button>
        </div>
        <div class="col-md-2">
          <button class="btn btn-secondary w-100" (click)="getStudents()">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 📝 Student Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">{{ isEditing ? '✏️ Edit Student' : '➕ Add Student' }}</h5>
      <form #studentForm="ngForm" (ngSubmit)="saveStudent(studentForm)" novalidate>
        <div class="row g-3">
          <!-- Student ID -->
          <div class="col-md-3">
            <label class="form-label">Student ID</label>
            <input
              type="number"
              class="form-control"
              name="studentId"
              [(ngModel)]="currentStudent.studentId"
              #studentId="ngModel"
              required
            />
            <div *ngIf="(studentId.touched || studentForm.submitted) && studentId.errors" class="text-danger small">
              Student ID is required
            </div>
          </div>

          <!-- Name -->
          <div class="col-md-3">
            <label class="form-label">Name</label>
            <input
              type="text"
              class="form-control"
              name="name"
              [(ngModel)]="currentStudent.name"
              #name="ngModel"
              required
            />
            <div *ngIf="(name.touched || studentForm.submitted) && name.errors" class="text-danger small">
              Name is required
            </div>
          </div>

          <!-- Class -->
          <div class="col-md-3">
            <label class="form-label">Class</label>
            <input
              type="text"
              class="form-control"
              name="class"
              [(ngModel)]="currentStudent.class"
              #classCtrl="ngModel"
              required
            />
            <div *ngIf="(classCtrl.touched || studentForm.submitted) && classCtrl.errors" class="text-danger small">
              Class is required
            </div>
          </div>

          <!-- Mobile -->
          <div class="col-md-3">
            <label class="form-label">Mobile No</label>
            <input
              type="text"
              class="form-control"
              name="mobileNo"
              [(ngModel)]="currentStudent.mobileNo"
              #mobileNo="ngModel"
              pattern="^[6-9]\\d{9}$"
              required
            />
            <div *ngIf="(mobileNo.touched || studentForm.submitted) && mobileNo.errors" class="text-danger small">
              <div *ngIf="mobileNo.errors['required']">Mobile number is required</div>
              <div *ngIf="mobileNo.errors['pattern']">Must be a valid 10-digit number starting with 6–9</div>
            </div>
          </div>

          <!-- Address -->
          <div class="col-md-6">
            <label class="form-label">Address</label>
            <input
              type="text"
              class="form-control"
              name="address"
              [(ngModel)]="currentStudent.address"
              #address="ngModel"
              required
            />
            <div *ngIf="(address.touched || studentForm.submitted) && address.errors" class="text-danger small">
              Address is required
            </div>
          </div>

          <!-- Role -->
          <div class="col-md-3">
            <label class="form-label">Role</label>
            <input
              type="text"
              class="form-control"
              name="Role"
              [(ngModel)]="currentStudent.Role"
              #role="ngModel"
              required
            />
            <div *ngIf="(role.touched || studentForm.submitted) && role.errors" class="text-danger small">
              Role is required
            </div>
          </div>

          <!-- Email -->
          <div class="col-md-3">
            <label class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              name="Email"
              [(ngModel)]="currentStudent.Email"
              #email="ngModel"
              required
            />
            <div *ngIf="(email.touched || studentForm.submitted) && email.errors" class="text-danger small">
              <div *ngIf="email.errors['required']">Email is required</div>
              <div *ngIf="email.errors['email']">Invalid email format</div>
            </div>
          </div>

          <!-- Attendance -->
          <div class="col-md-3">
            <label class="form-label">Attendance %</label>
            <input
              type="number"
              class="form-control"
              name="attendance"
              [(ngModel)]="currentStudent.attendance"
              #attendance="ngModel"
              min="0"
              max="100"
              required
            />
            <div *ngIf="(attendance.touched || studentForm.submitted) && attendance.errors" class="text-danger small">
              <div *ngIf="attendance.errors['required']">Attendance is required</div>
              <div *ngIf="attendance.errors['min'] || attendance.errors['max']">Must be between 0 and 100</div>
            </div>
          </div>

          <!-- Class Teacher -->
          <div class="col-md-3">
            <label class="form-label">Class Teacher</label>
            <input
              type="text"
              class="form-control"
              name="classteacher"
              [(ngModel)]="currentStudent.classteacher"
            />
          </div>

          <!-- Notice -->
          <div class="col-md-12">
            <label class="form-label">Notice</label>
            <textarea
              class="form-control"
              name="Notice"
              [(ngModel)]="currentStudent.Notice"
              rows="2"
            ></textarea>
          </div>

          <!-- Photo Upload -->
          <div class="col-md-6">
            <label class="form-label">Photo</label>
            <input
              type="file"
              class="form-control"
              (change)="onFileSelected($event)"
              accept="image/*"
            />
            <div *ngIf="currentStudent.photo" class="mt-2">
              <img
                [src]="currentStudent.photo"
                alt="Preview"
                class="img-thumbnail"
                style="max-height: 120px;"
              />
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-end mt-3">
          <button type="submit" class="btn btn-success me-2" >
            {{ isEditing ? 'Update Student' : 'Add Student' }}
          </button>
          <button type="button" class="btn btn-warning" (click)="resetForm(studentForm)">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 📋 Students Table -->
<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="card-title">📋 Students List</h5>
    <div class="table-responsive">
      <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th (click)="sortData('photo')">Photo</th>
            <th (click)="sortData('studentId')">ID</th>
            <th (click)="sortData('name')">Name</th>
            <th (click)="sortData('class')">Class</th>
            <th (click)="sortData('mobileNo')">Mobile</th>
            <th (click)="sortData('Email')">Email</th>
            <th (click)="sortData('Role')">Role</th>
            <th (click)="sortData('attendance')">Attendance</th>
            <th (click)="sortData('classteacher')">Teacher</th>
            <th>Actions</th>
          </tr>
          <!-- Filter row -->
          <tr>
            <th></th>
            <th><input class="form-control form-control-sm" [(ngModel)]="filters.studentId" placeholder="Filter" /></th>
            <th><input class="form-control form-control-sm" [(ngModel)]="filters.name" placeholder="Filter" /></th>
            <th><input class="form-control form-control-sm" [(ngModel)]="filters.class" placeholder="Filter" /></th>
            <th><input class="form-control form-control-sm" [(ngModel)]="filters.mobileNo" placeholder="Filter" /></th>
            <th><input class="form-control form-control-sm" [(ngModel)]="filters.Email" placeholder="Filter" /></th>
            <th><input class="form-control form-control-sm" [(ngModel)]="filters.Role" placeholder="Filter" /></th>
            <th><input class="form-control form-control-sm" [(ngModel)]="filters.attendance" placeholder="Filter" /></th>
            <th><input class="form-control form-control-sm" [(ngModel)]="filters.classteacher" placeholder="Filter" /></th>
            <th>
              <button class="btn btn-sm btn-outline-secondary" (click)="clearFilters()">Clear</button>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let student of getFilteredAndSortedStudents()">
            <!-- Photo -->
            <td>
              <img
                *ngIf="student.photo"
                [src]="student.photo"
                alt="Student Photo"
                class="img-thumbnail"
                style="max-height: 60px;"
              />
              <span *ngIf="!student.photo" class="text-muted">No Photo</span>
            </td>

            <!-- ID -->
            <td><span class="badge bg-secondary">{{ student.studentId }}</span></td>

            <!-- Name -->
            <td>{{ student.name }}</td>

            <!-- Class -->
            <td>{{ student.class }}</td>

            <!-- Mobile -->
            <td>{{ student.mobileNo }}</td>

            <!-- Email -->
            <td>{{ student.Email }}</td>

            <!-- Role with badge -->
            <td>
              <span
                [ngClass]="{
                  'badge bg-primary': student.Role?.toLowerCase() === 'admin',
                  'badge bg-info text-dark': student.Role?.toLowerCase() === 'teacher',
                  'badge bg-secondary': student.Role?.toLowerCase() === 'student',
                  'badge bg-dark': !student.Role
                }"
              >
                {{ student.Role || 'N/A' }}
              </span>
            </td>

            <!-- Attendance with badge -->
            <td>
              <span
                [ngClass]="{
                  'badge bg-success': student.attendance >= 75,
                  'badge bg-warning': student.attendance >= 50 && student.attendance < 75,
                  'badge bg-danger': student.attendance < 50
                }"
              >
                {{ student.attendance }}%
              </span>
            </td>

            <!-- Teacher -->
            <td>{{ student.classteacher }}</td>

            <!-- Actions -->
            <td>
              <button class="btn btn-sm btn-primary me-2" (click)="editStudent(student)">✏️ Edit</button>
              <button class="btn btn-sm btn-danger" (click)="deleteStudent(student.studentId)">🗑️ Delete</button>
            </td>
          </tr>

          <!-- Empty state -->
          <tr *ngIf="students.length === 0">
            <td colspan="10" class="text-center text-muted">No students found.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>