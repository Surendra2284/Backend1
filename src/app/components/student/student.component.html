<div class="student-page container-fluid py-3">

  <!-- ====================== PAGE HEADER ====================== -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="fw-bold mb-1">üéì Student Management</h2>
      <div class="text-muted">Manage all students, bulk import, filters & reports</div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-outline-primary btn-sm" (click)="downloadTemplate()">
        <i class="bi bi-download me-1"></i> Template
      </button>

      <label class="btn btn-primary btn-sm mb-0">
        <i class="bi bi-file-earmark-spreadsheet me-1"></i> Import Excel
        <input type="file" accept=".xlsx,.xls" (change)="onExcelSelected($event)" hidden>
      </label>
    </div>
  </div>

  <div class="row g-4">

    <!-- ========================================================= -->
    <!-- LEFT SIDE : Add/Edit Student + Bulk Import Preview        -->
    <!-- ========================================================= -->
    <div class="col-lg-4">

      <!-- ====================== ADD / EDIT FORM ====================== -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <h5 class="fw-bold">{{ isEditing ? '‚úèÔ∏è Edit Student' : '‚ûï Add Student' }}</h5>

          <form #studentForm="ngForm" (ngSubmit)="saveStudent(studentForm)" novalidate class="mt-3">

            <div class="mb-3">
              <label class="form-label">Student ID</label>
              <input name="studentId" class="form-control" required [(ngModel)]="currentStudent.studentId">
            </div>

            <div class="mb-3">
              <label class="form-label">Full Name</label>
              <input name="name" class="form-control" required [(ngModel)]="currentStudent.name">
            </div>

            <div class="mb-3">
              <label class="form-label">Class</label>
              <input name="class" class="form-control" required [(ngModel)]="currentStudent.class">
            </div>

            <div class="mb-3">
              <label class="form-label">Mobile No</label>
              <input name="mobileNo" class="form-control" [(ngModel)]="currentStudent.mobileNo">
            </div>

            <div class="mb-3">
              <label class="form-label">Email</label>
              <input name="Email" class="form-control" type="email" [(ngModel)]="currentStudent.Email">
            </div>

            <div class="mb-3">
  <label class="form-label d-block">Role</label>
  <span class="form-control-plaintext">Student</span>
</div>

            <!-- CLASS TEACHER DROPDOWN -->
            <div class="mb-3">
              <label class="form-label">Class Teacher</label>
              <select
                name="classteacher"
                class="form-control"
                [(ngModel)]="currentStudent.classteacher"
              >
                <option value="">-- Select Teacher --</option>
                <option *ngFor="let t of teachers" [value]="t.name">
                  {{ t.name }}
                </option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Address</label>
              <textarea name="address" rows="2" class="form-control" [(ngModel)]="currentStudent.address"></textarea>
            </div>

            <!-- Photo Upload -->
            <div class="mb-3">
              <label class="form-label">Photo (optional)</label>
              <input type="file" accept="image/*" (change)="onFileSelected($event)" class="form-control">

              <div *ngIf="currentStudent.photo" class="mt-2 text-center">
                <small class="text-muted d-block">Preview:</small>
                <img
                  [src]="currentStudent.photo"
                  class="rounded shadow-sm border"
                  style="max-width: 100%; max-height: 200px; object-fit: cover;">
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-success w-100" [disabled]="studentForm.invalid">
                {{ isEditing ? 'Update' : 'Add' }}
              </button>
              <button type="button" class="btn btn-outline-secondary" (click)="resetForm(studentForm)">
                Reset
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- ====================== BULK PREVIEW ====================== -->
      <div class="card shadow-sm">
        <div class="card-body">

          <h6 class="fw-bold mb-2">üìÑ Bulk Import Preview</h6>

          <div *ngIf="bulkErrors.length" class="alert alert-danger p-2 small">
            <strong>Errors found:</strong>
            <ul class="mb-0">
              <li *ngFor="let e of bulkErrors">{{ e }}</li>
            </ul>
          </div>

          <div *ngIf="!bulkPreview.length && !bulkErrors.length" class="text-muted small">
            No file loaded yet.
          </div>

          <div *ngIf="bulkPreview.length" style="max-height: 240px; overflow-y: auto;">
            <table class="table table-sm table-bordered">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>Name</th>
                  <th>Class</th>
                  <th>Mobile</th>
                  <th>Email</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let r of bulkPreview">
                  <td>{{ r.studentId }}</td>
                  <td>{{ r.name }}</td>
                  <td>{{ r.class }}</td>
                  <td>{{ r.mobileNo }}</td>
                  <td>{{ r.Email }}</td>
                </tr>
              </tbody>
            </table>

            <div class="d-flex gap-2 mt-2">
              <button class="btn btn-primary btn-sm w-100" (click)="commitBulk()">
                Import Data
              </button>
              <button class="btn btn-outline-secondary btn-sm" (click)="bulkPreview=[]; bulkErrors=[]">
                Clear
              </button>
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- ========================================================= -->
    <!-- RIGHT SIDE : Search / Filters / Student Table / Report    -->
    <!-- ========================================================= -->
    <div class="col-lg-8">

      <!-- ====================== SEARCH + FILTERS ====================== -->
      <div class="card shadow-sm mb-4">
        <div class="card-body">

          <div class="row g-2">
            <div class="col-md-7">
              <div class="input-group">
                <input class="form-control" placeholder="Search students..." [(ngModel)]="searchQuery">
                <select class="form-select" [(ngModel)]="searchBy">
                  <option value="class">By Class</option>
                  <option value="name">By Name</option>
                </select>
                <button class="btn btn-primary" (click)="searchStudents()">
                  Search
                </button>
              </div>
            </div>

            <div class="col-md-5 text-end">
              <button class="btn btn-outline-secondary btn-sm" (click)="clearFilters()">Reset Filters</button>
            </div>
          </div>

          <!-- Filter Row -->
          <div class="row g-2 mt-3 small">
            <div class="col-3">
              <input class="form-control form-control-sm" placeholder="ID" [(ngModel)]="filters.studentId">
            </div>
            <div class="col-3">
              <input class="form-control form-control-sm" placeholder="Name" [(ngModel)]="filters.name">
            </div>
            <div class="col-3">
              <input class="form-control form-control-sm" placeholder="Class" [(ngModel)]="filters.class">
            </div>
            <div class="col-3">
              <input class="form-control form-control-sm" placeholder="Mobile" [(ngModel)]="filters.mobileNo">
            </div>
          </div>

        </div>
      </div>

      <!-- ====================== STUDENT TABLE ====================== -->
      <div class="card shadow-sm mb-4">
        <div class="card-body p-0">

          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead class="table-light">
                <tr>
                  <th>Photo</th>
                  <th (click)="sortData('studentId')" class="sortable">ID</th>
                  <th (click)="sortData('name')" class="sortable">Name</th>
                  <th (click)="sortData('class')" class="sortable">Class</th>
                  <th>Mobile</th>
                  <th>Notice</th>
                  <th>Role</th>
                  <th>Class Teacher</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>

              <tbody>
                <tr *ngFor="let s of paginatedStudents; trackBy: trackByStudent">
                  <td>
                    <img
                      *ngIf="s.photo"
                      [src]="s.photo"
                      style="width:45px;height:45px;border-radius:6px;object-fit:cover;">
                  </td>
                  <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary" (click)="editStudent(s)">Edit</button>
                    <button class="btn btn-sm btn-outline-danger ms-1" (click)="deleteStudent(s.studentId)">
                      Delete
                    </button>
                  </td>
                  <td>{{ s.studentId }}</td>
                  <td>{{ s.name }}</td>
                  <td>{{ s.class }}</td>
                  <td>{{ s.mobileNo }}</td>
                  <td>{{ s.Notice }}</td>
                  
                  <td>{{ s.classteacher }}</td>
                  
                </tr>

                <tr *ngIf="!paginatedStudents.length">
                  <td colspan="9" class="text-center text-muted py-3">
                    No students found.
                  </td>
                </tr>

              </tbody>
            </table>
          </div>

        </div>
      </div>

      <!-- ====================== PAGINATION ====================== -->
      <div class="d-flex justify-content-between align-items-center mb-4">

        <!-- page buttons hidden on small screens -->
        <div class="pagination-pages d-none d-md-flex">

          <button class="btn btn-sm btn-outline-secondary" [disabled]="page<=1" (click)="prevPage()">
            Prev
          </button>

          <ng-container *ngFor="let p of [].constructor(totalPages); let i = index;">
            <button
              class="btn btn-sm"
              [ngClass]="page===i+1 ? 'btn-primary' : 'btn-outline-secondary'"
              (click)="goToPage(i+1)">
              {{ i+1 }}
            </button>
          </ng-container>

          <button class="btn btn-sm btn-outline-secondary" [disabled]="page>=totalPages" (click)="nextPage()">
            Next
          </button>
        </div>

        <!-- on small screens you still have Prev/Next via another control if you want, or only rows-per-page -->
        <div class="d-flex align-items-center gap-2">
          <small class="me-2">Rows per page:</small>
          <select
            #pageSizeSelect
            class="form-select form-select-sm w-auto"
            [value]="pageSize"
            (change)="onPageSizeChange(pageSizeSelect.value)"
          >
            <option [value]="5">5</option>
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
          </select>
        </div>

      </div>

      <!-- ====================== REPORT SECTION ====================== -->
      <div class="card shadow-sm">
        <div class="card-body">

          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="fw-bold mb-0">üìä Class-wise Report</h5>
            <div>
              <button class="btn btn-sm btn-outline-primary" (click)="exportClassReport()">
                Export Report
              </button>
            </div>
          </div>

          <table class="table table-sm table-bordered" *ngIf="getClassReport().length; else noReport">
            <thead class="table-light">
              <tr>
                <th>Class</th>
                <th>Students</th>
                <th>Avg Attendance (%)</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let r of getClassReport()">
                <td>{{ r.className }}</td>
                <td>{{ r.count }}</td>
                <td>{{ r.avgAttendance }}</td>
              </tr>
            </tbody>
          </table>

          <ng-template #noReport>
            <div class="text-muted small">No report data available.</div>
          </ng-template>

        </div>
      </div>

    </div>
  </div>
</div>
