<div class="container py-4 teacher-container" [class.loading]="loading">

  <!-- Toast -->
  <div *ngIf="showToast" class="toast-message" [ngClass]="toastType">{{ toastMessage }}</div>

  <!-- Header / Controls -->
  <div class="card shadow-sm border-0 p-3 mb-3">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <h2 class="m-0">Teachers</h2>
        <small class="text-muted">Manage teacher profiles, photos and classes</small>
      </div>

      <div class="d-flex gap-2 align-items-center flex-wrap">
        <div class="input-group input-group-sm" style="width: 260px;">
          <span class="input-group-text">Search</span>
          <input type="text"
                 class="form-control"
                 placeholder="name, subject, class..."
                 [(ngModel)]="query"
                 (ngModelChange)="page=1" />
        </div>

        <div class="input-group input-group-sm" style="width: 180px;">
          <span class="input-group-text">Page size</span>
          <select class="form-select"
                  [ngModel]="pageSize"
                  (ngModelChange)="setPageSize($event)">
            <option *ngFor="let s of [4,8,12,20]" [value]="s">{{ s }}</option>
          </select>
        </div>

        <div class="btn-group btn-group-sm">
          <button type="button"
                  class="btn btn-outline-primary"
                  [class.active]="viewMode==='table'"
                  (click)="setView('table')">
            Table
          </button>
          <button type="button"
                  class="btn btn-outline-primary"
                  [class.active]="viewMode==='grid'"
                  (click)="setView('grid')">
            Grid
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add / Edit Form -->
  <div class="card shadow-lg border-0 p-4 mb-4">
    <h4 class="mb-3 text-primary fw-bold">
      {{ isEdit ? '‚úèÔ∏è Edit Teacher' : '‚ûï Add New Teacher' }}
    </h4>

    <form [formGroup]="teacherForm" (ngSubmit)="onSubmit()" novalidate>
      <div class="row g-3">
        <div class="col-md-3">
          <label class="form-label fw-semibold">Teacher ID</label>
          <input type="text" class="form-control form-control-sm" formControlName="teacherid" />
          <small class="text-danger"
                 *ngIf="teacherForm.get('teacherid')?.touched && teacherForm.get('teacherid')?.hasError('required')">
            Required
          </small>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Name</label>
          <input type="text" class="form-control form-control-sm" formControlName="name" />
          <small class="text-danger"
                 *ngIf="teacherForm.get('name')?.touched && teacherForm.get('name')?.hasError('required')">
            Required
          </small>
        </div>

        <!-- Assign Class from API -->
        <div class="col-md-3">
          <label class="form-label fw-semibold">Assign Class</label>
          <select class="form-select form-select-sm"
                  formControlName="Assignclass">
            <option value="" disabled>-- Select Class --</option>
            <option *ngFor="let c of classes" [value]="c">
              {{ c }}
            </option>
          </select>
          <small class="text-muted" *ngIf="loadingClasses">Loading classes‚Ä¶</small>
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Mobile</label>
          <input type="text" class="form-control form-control-sm" formControlName="mobileNo" />
          <small class="text-danger" *ngIf="teacherForm.get('mobileNo')?.hasError('pattern')">
            Must be 10 digits
          </small>
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">Address</label>
          <input type="text" class="form-control form-control-sm" formControlName="address" />
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Role</label>
          <input type="text" class="form-control form-control-sm" formControlName="Role" />
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Notice</label>
          <input type="text" class="form-control form-control-sm" formControlName="Notice" />
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Email</label>
          <input type="email" class="form-control form-control-sm" formControlName="Email" />
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Subject</label>
          <input type="text" class="form-control form-control-sm" formControlName="subject" />
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Attendance %</label>
          <input type="number" class="form-control form-control-sm" formControlName="attendance" />
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Class Teacher</label>
          <input type="text" class="form-control form-control-sm" formControlName="classteacher" />
        </div>

        <div class="col-md-3">
          <label class="form-label fw-semibold">Experience (Years)</label>
          <input type="number" class="form-control form-control-sm" formControlName="experience" />
        </div>

        <div class="col-md-6">
          <label class="form-label fw-semibold">Photo</label>
          <input type="file" class="form-control form-control-sm" (change)="onPhotoUpload($event)" />
          <div *ngIf="teacherForm.get('photo')?.value" class="mt-2 text-center">
            <img
              [src]="teacherForm.get('photo')?.value"
              alt="Preview"
              class="img-thumbnail shadow-sm border border-primary"
              style="max-height: 120px; border-radius: 10px;"
            />
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-end mt-4 gap-2">
        <button type="submit"
                class="btn btn-success px-4 shadow-sm"
                [disabled]="teacherForm.invalid">
          {{ isEdit ? 'Update Teacher' : 'Add Teacher' }}
        </button>
        <button type="button"
                class="btn btn-secondary px-4 shadow-sm"
                (click)="resetForm()">
          Clear
        </button>
      </div>
    </form>
  </div>

  <!-- Listing -->
  <div class="card shadow-lg border-0 p-3">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="text-primary fw-bold m-0">
        üìã Teacher Directory
        <span class="badge bg-secondary ms-2">{{ sorted.length }}</span>
      </h5>

      <!-- Sort -->
      <div class="d-flex gap-2">
        <div class="input-group input-group-sm" style="width: 220px;">
          <span class="input-group-text">Sort by</span>
          <select class="form-select"
                  [ngModel]="sortKey"
                  (ngModelChange)="changeSort($event)">
            <option value="name">Name</option>
            <option value="subject">Subject</option>
            <option value="Assignclass">Class</option>
            <option value="Email">Email</option>
          </select>
        </div>
        <button class="btn btn-sm btn-outline-primary"
                (click)="sortDir = sortDir==='asc' ? 'desc' : 'asc'">
          {{ sortDir === 'asc' ? 'Asc' : 'Desc' }}
        </button>
      </div>
    </div>

    <!-- GRID VIEW -->
    <div *ngIf="viewMode==='grid'">
      <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3"
             *ngFor="let t of paged; trackBy: trackById">
          <div class="card h-100 shadow-sm">
            <div class="card-body d-flex flex-column align-items-center text-center">
              <img [src]="formatPhoto(t.photo)" alt="Teacher"
                   class="rounded-circle border border-2 mb-3"
                   style="width:90px;height:90px;object-fit:cover;">
              <h6 class="mb-0">{{ t.name }}</h6>
              <small class="text-muted">{{ t.Email }}</small>
              <div class="mt-2">
                <span class="badge bg-primary-subtle text-primary me-1">{{ t.subject }}</span>
                <span class="badge bg-success-subtle text-success">Class {{ t.Assignclass || '‚Äî' }}</span>
              </div>
              <div class="mt-3 d-flex gap-2">
                <button class="btn btn-sm btn-outline-primary" (click)="editTeacher(t)">Edit</button>
                <button class="btn btn-sm btn-outline-danger" (click)="deleteTeacher(t)">Delete</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- TABLE VIEW -->
    <div *ngIf="viewMode==='table'">
      <table class="table table-hover align-middle text-center table-bordered rounded-3 overflow-hidden">
        <thead class="table-primary text-dark">
          <tr>
            <th>Photo</th>
            <th (click)="changeSort('name')"        style="cursor:pointer">Name</th>
            <th (click)="changeSort('Email')"       style="cursor:pointer">Email</th>
            <th (click)="changeSort('subject')"     style="cursor:pointer">Subject</th>
            <th>Mobile</th>
            <th (click)="changeSort('Assignclass')" style="cursor:pointer">Assign Class</th>
            <th>Class Teacher</th>
            <th>Notice</th>
            <th>Actions</th>
          </tr>
        </thead>

        <tbody *ngIf="paged.length; else noData">
          <tr *ngFor="let teacher of paged; trackBy: trackById" class="table-row">
            <td>
              <img
                [src]="formatPhoto(teacher.photo)"
                alt="Teacher Photo"
                class="rounded-circle border border-secondary shadow-sm"
                style="height: 60px; width: 60px; object-fit: cover;"
              />
            </td>
            <td>{{ teacher.name }}</td>
            <td>{{ teacher.Email }}</td>
            <td>{{ teacher.subject }}</td>
            <td>{{ teacher.mobileNo }}</td>
            <td>{{ teacher.Assignclass }}</td>
            <td>{{ teacher.classteacher }}</td>
            <td>{{ teacher.Notice }}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary me-1" (click)="editTeacher(teacher)">Edit</button>
              <button class="btn btn-sm btn-outline-danger" (click)="deleteTeacher(teacher)">Delete</button>
            </td>
          </tr>
        </tbody>

        <ng-template #noData>
          <tbody>
            <tr>
              <td colspan="9" class="text-muted py-3">No teachers found.</td>
            </tr>
          </tbody>
        </ng-template>
      </table>
    </div>

    <!-- Pager -->
    <div class="d-flex align-items-center justify-content-between mt-2">
      <div class="text-muted small">
        Showing <strong>{{ paged.length }}</strong> of <strong>{{ sorted.length }}</strong>
      </div>
      <div class="btn-group">
        <button class="btn btn-sm btn-outline-secondary"
                (click)="prevPage()"
                [disabled]="page<=1">
          ¬´ Prev
        </button>
        <button class="btn btn-sm btn-outline-secondary" disabled>
          Page {{ page }} / {{ totalPages }}
        </button>
        <button class="btn btn-sm btn-outline-secondary"
                (click)="nextPage()"
                [disabled]="page>=totalPages">
          Next ¬ª
        </button>
      </div>
    </div>
  </div>

  <!-- Loading overlay -->
  <div class="loading-overlay" *ngIf="loading">
    <div class="spinner"></div>
    <div>Working‚Ä¶</div>
  </div>
</div>
    